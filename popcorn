#!/usr/bin/env bash
#
# ############################################################################
# Project: scripts (none)
# File...: popcorn
# Created: 2020/03/06 - 19:26:02
# Author.: Fabiano Matos, fgm (fabiano.matoz@gmail.com) 
#        (take idea for another script)
# ~·~·~·~·~·~·~·~·~·~·~·~·~~·~·~·~·~·~·~·~·~·~·~·~·~~·~·~·~·~·~~·~·~·~·~·~·~·~
# Last Modified: Sunday, 2023/04/09 - 12:49:55
# Modified By..: @fbnmtz, (fabiano.matoz@gmail.com)
# ~·~·~·~·~·~·~·~·~·~·~·~·~~·~·~·~·~·~·~·~·~·~·~·~·~~·~·~·~·~·~~·~·~·~·~·~·~·~
# Version: 1.1.6.166
# ~·~·~·~·~·~·~·~·~·~·~·~·~~·~·~·~·~·~·~·~·~·~·~·~·~~·~·~·~·~·~~·~·~·~·~·~·~·~
# Description: 
#  > popcorn (term version)
#        use terminial to watch movies / series.
#        you search for a name, get a list of torrents and select one to watch
#        directly in mpv
# 
# we use two programs
#   * pirateget (finds and downloads torrents from the Pirate Bay)
#   * peerflix (open a magnetlink, download and open video in a given player (mpv))
# ############################################################################
# HISTORY:
#

# shellcheck disable=SC1090        # SC1090: Can't follow non-constant source. Use a directive to specify location.
source ~/bin/xSHELL/init
use args
xrequirements pirate-get peerflix mpv

player=mpv 

xarg --id -s,--search --var search+o --desc "term for search a torrent"
xarg --id -m,--magnet --var magnet+r --desc "magnet link for download"
xarg --id -p,--player --var player+r --desc "set player to watch torrent"

xrun --xversionrc --xrequire-one "$@"

if [ -z "$magnet" ]; then
    # shellcheck disable=SC2124     # SC2124: Assigning an array to a string! Assign as array, or use * instead of @ to concatenate.
    [ -z "$search" ] && search="$@"
    # shellcheck disable=SC2145     # SC2145: Argument mixes string and array. Use * or separate argument.
    pirate-get -C \
        "peerflix %s --all --list --subtitles --no-quit --$player  -- \"$@\"" \
        "$search"
else
    cmd="peerflix \"<link>\" --all --list --subtitles --no-quit --$player --"
    if [[ "$magnet" =~ "magnet:?xt=" ]]; then
        link=${magnet^^}
    else
        # get magnet by folder/file name  
        link="magnet:?xt=urn:btih:${magnet//.torrent}"
    fi
    cmd=${cmd//<link>/${link}}
    echo "$cmd"
    eval "$cmd"
fi

# docker run -p 9000:9000 -p 6881:6881 -p 6881:6881/udp \
#     --rm -v /tmp/torrent-stream:/tmp/torrent-stream asapach/peerflix-server
